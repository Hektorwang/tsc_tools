# 系统运行环境采集检查和基础环境完工检查工具

## 功能说明

### 系统运行环境检查

- 当现场系统出现故障时，为避免现场运维人员因技术能力差异，在排查过程中难以详细排查和采集故障设备的各种运行状态，对支撑人员解决问题不能提供尽可能详细的信息，需编写工具采集各类系统信息生成详细记录。该记录可供现场运维人员和支撑人员使用。
- 同时对部分信息进行分析，发现有异常或需要关注的情况则直接告警提示。
- 提供单节点运行模式, 和批量调度模式

### 基础环境完工检查

- 按刘俊和申志远提供的《基础环境完工检查项.xlsx》对待交付的主机进行检查是否满足交付条件.
- 仅提供批量调度模式

## 使用方法

本工具必须使用 `root` 权限执行.  
待检查主机需关闭 selinux, 并进行过补包.  
待检查主机必须安装 tsc 工具集 1.6 以上版本.
首先配置工具 globe.common.conf, 配置方法见文件中说明. 注意其中标注的 `必须配置` 项. 除 `压测模块` 外其他 `必须配置项` 必须配置, 若要执行 `压测模块` 则对应的 `压测模块` 中 `必须配置` 项必须配置.

### 单节点执行 系统运行环境检查

```bash
# 查看本帮助
./run.sh -h
# 执行默认模块
./run.sh
# 指定模块和模块对应参数执行
./run.sh -m "模块1" -m "模块2" [-a "模块2参数"] -m "模块3" # 性能测试模块建议每次仅运行一个
# 查看模块列表
./run.sh -l
# 查看模块帮助
./run.sh -m "模块1" -m "模块2" -h
```

当工具运行完成后, 会将运行日志生成在 `log/run.sh_最新时间`, 附件生成在 `log/最新时间/`, 需将这两个结果压缩打包返回.

### 批量执行

批量执行功能除了需要配置 `globe.common.conf` 外还需要配置 `etc/ansible_hosts.ini` 指明待测节点信息.
批量执行功能需要管理主机安装了 `tsc_pyenv`, 所有待测节点安装了最新版 `tsc_tools`(大于 `1.6.3`).  
批量执行功能时, 会将生成的汇总结果文件放到工具目录下 `batch_logs` 目录下, 工具每次执行时都会清除这个目录里面的历史文件, 若有需要请自行保存该目录中历史文件.

**批量模式运行时间比较长, 建议在 `screen` 中运行. 必须在工具主目录下执行, 即 `cd tsc_sysinfo/; 执行某操作`**  
**批量模式运行时间比较长, 建议在 `screen` 中运行. 必须在工具主目录下执行, 即 `cd tsc_sysinfo/; 执行某操作`**  
**批量模式运行时间比较长, 建议在 `screen` 中运行. 必须在工具主目录下执行, 即 `cd tsc_sysinfo/; 执行某操作`**  
**批量模式运行时间比较长, 建议在 `screen` 中运行. 必须在工具主目录下执行, 即 `cd tsc_sysinfo/; 执行某操作`**

#### 批量执行 系统运行环境采集

**注意:** 在批量模式下, 若需对部分主机检查 pg 死锁(pg_deadlock), 需在 `ansible_hosts.ini` 中对这些主机指定 `is_pg=0` 和 `pg_cmd`  
采集的日志在工具 `batch_logs` 目录下

```bash
# 仅生成日志摘要汇总模式
# 批量执行时不含压测. 仅生成汇总结果不采集全量日志, 这种情况下全量日志仍会保留在测试主机中, 管理主机上仅采集run.log
tsc_ansible-playbook -i "${PWD}"/etc/ansible_hosts.ini "${PWD}"/roles/sysinfo-slim.yml
# 全量采集模式
# 批量执行时不含压测. 生成汇总结果且采集全量日志, 这种情况下测试主机的全量日志都会拷贝回管理主机, 请按每测试主机 200MB 准备存储
tsc_ansible-playbook -i "${PWD}"/etc/ansible_hosts.ini "${PWD}"/roles/sysinfo-all.yml
```

#### 批量执行 基础环境完工检查

`基础环境完工检查` 主要分为两类. 一类是配置检查, 使用 `delivery_check.yml` 执行; 一类是性能检查, 分为 `stress-ng(压测)`, `fio(存储性能测试)`, `iperf3(带宽测试)` 三个模块. 上述 4 个部分的检查需分步执行.  
批量执行 `基础环境完工检查` 功能时, 涉及到 `stress-ng`, `fio` 两个性能测试模块, 这些模块均需要执行较长时间. 本工具设定默认一次执行 `50` 个并发. 若要测试如 `300` 台服务器, 每节点测试时间 `2h` , 则需要 `300/50*2=12h` 才能完成全部测试. 在此场景下, 需用多台管理主机 ( 300 / 50 = 6 台) 分开调度待测试机器进行测试, 将每个管理主机调度的测试节点控制在并发数以下, 否则可能导致任务调度超时.  
`stress-ng` 检查不提供汇总结果文件仅提供压测后机器联通性日志, 因压测失败的主机会死机不会生成任何日志.  
带宽测试模块 `iperf3` 仅支持串行运行, 对带宽进行测试前, 需根据待测试的网络环境, 合理规划待测主机(`iperf3Client`)和测速服务器(`iperf3Server`)的对应关系, 以获取所需了解的服务器之间网络链路带宽情况.  
`delivery.xlsx`, `fio.xlsx`, `iperf3.xlsx` 为实测样例.

```bash
# 批量执行 基础环境完工检查 功能, 批量执行时不含压测
tsc_ansible-playbook -i "${PWD}"/etc/ansible_hosts.ini "${PWD}"/roles/delivery_check.yml
# 批量执行 基础环境完工检查 的 stress-ng 压测 (cpu, 内存, 系统盘)
# 默认每次并发测试 50 台, 若需要压测更多机器, 建议使用多台管理主机调度
tsc_ansible-playbook -i "${PWD}"/etc/ansible_hosts.ini "${PWD}"/roles/stress-ng.yml
# 批量执行 基础环境完工检查 的 fio 压测(磁盘性能)
# 默认每次并发测试 50 台, 若需要压测更多机器, 需使用多台管理主机调度
tsc_ansible-playbook -i "${PWD}"/etc/ansible_hosts.ini "${PWD}"/roles/fio.yml
# 批量执行 基础环境完工检查 的 iperf3 压测(带宽), 带宽测试为串行执行, 时间和需要测试的客户端数量成正比
tsc_ansible-playbook -i "${PWD}"/etc/ansible_hosts.ini "${PWD}"/roles/iperf3.yml
```

## 模块列表

- 模块帮助见具体模块 ./run.sh -m "模块名" -h
- 模块详情汇总见 `系统运行环境采集检查和基础环境完工检查工具模块列表`

| 模块名             | 功能简介                                 | 是否默认执行                                           |
| ------------------ | ---------------------------------------- | ------------------------------------------------------ |
| blkid              | 采集 blkid 信息                          | 是                                                     |
| cpu_performance    | 判断 CPU 节能                            | 是                                                     |
| cpu_virtualization | 判断 CPU 虚拟化                          | 是                                                     |
| cron               | 采集系统计划任务配置和日志               | 是                                                     |
| diskinfo           | 检查阵列信息                             | 是                                                     |
| diskrw             | 检查各挂载点是否只读                     | 是                                                     |
| dmesg              | 采集 dmesg -T 信息                       | 是                                                     |
| dmidecode          | 采集 dmidecode 信息                      | 是                                                     |
| firewall           | 采集防火墙 ipt nft firwalld 规则         | 是                                                     |
| fio                | 检查存储 IO 性能                         | 否                                                     |
| fude               | 检查 fude                                | 是                                                     |
| grub               | 采集 GRUB 配置信息                       | 是                                                     |
| hostname           | 采集主机名信息                           | 是                                                     |
| iperf3             | 判断本机和给定的对端主机网速是否达标     | 否(暂时废弃, 改为使用批量执行基础环境完工检查功能完成) |
| ipmi               | 采集 ipmi 信息                           | 是                                                     |
| java_mem           | 采集操作系统上所有 java 进程             | 是                                                     |
| login              | 采集系统登录信息                         | 是                                                     |
| lsblk              | 采集 lsblk -l 信息                       | 是                                                     |
| lscpu              | 采集 CPU 型号                            | 是                                                     |
| lsmod              | 采集系统加载模块信息                     | 是                                                     |
| lsof               | 采集 lsof -nPoR 信息                     | 是                                                     |
| lspci              | 采集 PCI 外设信息                        | 是                                                     |
| mem                | 检查内存使用情况                         | 是                                                     |
| messages           | 采集 messages 日志                       | 是                                                     |
| network            | 采集系统网络配置信息                     | 是                                                     |
| ntp                | 分析系统对时计划任务                     | 是                                                     |
| network_connection | 判断本机是否能 ping 通给定的重要节点列表 | 否                                                     |
| pg_deadlock        | pg 有卡住的独占锁                        | 是(可配置)                                             |
| resolv             | 采集并检查 DNS 配置信息                  | 是                                                     |
| runlevel           | 检查系统启动级别                         | 是                                                     |
| sar                | 检查历史资源使用信息                     | 是                                                     |
| secure             | 采集系统 secure 日志                     | 是                                                     |
| sellinux           | 检查 selinux 配置                        | 是                                                     |
| service            | 检查系统服务配置和运行状态               | 是                                                     |
| ss                 | 采集系统网络连接 信息                    | 是                                                     |
| sshdport           | 检查 sshd 服务是否监听 22 端口           | 是                                                     |
| storage_used       | 检查各挂载点存储用量                     | 是                                                     |
| stress             | 对本机进行压测                           | 否                                                     |
| system_parameter   | 采集系统参数                             | 是                                                     |
| vmstat             | 采集系统负载信息                         | 是                                                     |
| weak_psw           | 检测系统用户弱密码                       | 仅基础环境完工检查模式运行                             |
| iptables_rules     | 检查是否开启了公司防火墙规则             | 仅基础环境完工检查模式运行                             |
| service_trim       | 检查服务是否裁剪                         | 仅基础环境完工检查模式运行                             |
