name: Integration Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  test-installation:
    name: Test Installation on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            dos2unix \
            gzip \
            tar \
            jq \
            dmidecode \
            lshw \
            pciutils

      - name: Build package
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Test installation (dry-run simulation)
        run: |
          release_file=$(find release -name "tsc_tools-*.sh" | head -n 1)
          
          # Extract without running install
          chmod +x "$release_file"
          
          # Test that the package can be extracted
          echo "Testing package extraction..."
          "$release_file" --info
          
          echo "✓ Package structure is valid"

      - name: Test function library
        run: |
          # Source the function library and test key functions
          source tsc_tools/func
          
          # Test logging functions
          echo "Testing logging functions..."
          LOGINFO "Test info message"
          LOGSUCCESS "Test success message"
          LOGWARNING "Test warning message"
          
          # Test version comparison
          echo "Testing version comparison..."
          if version_gt "2.0.0" "1.9.9"; then
            echo "✓ version_gt works"
          else
            echo "✗ version_gt failed"
            exit 1
          fi
          
          if version_lt "1.9.9" "2.0.0"; then
            echo "✓ version_lt works"
          else
            echo "✗ version_lt failed"
            exit 1
          fi
          
          echo "✓ Function library tests passed"

      - name: Test module structure
        run: |
          echo "Checking module structure..."
          
          modules_dir="tsc_tools/modules"
          if [ ! -d "$modules_dir" ]; then
            echo "✗ Modules directory not found"
            exit 1
          fi
          
          module_count=0
          for module in "$modules_dir"/*; do
            if [ -d "$module" ]; then
              module_name=$(basename "$module")
              echo "Checking module: $module_name"
              
              # Check for required files
              if [ ! -f "$module/module.json" ] && [ ! -f "$module/readme.md" ]; then
                echo "⚠️  Module $module_name missing module.json or readme.md"
              fi
              
              if [ ! -f "$module/run.sh" ]; then
                echo "⚠️  Module $module_name missing run.sh"
              else
                # Check if run.sh is executable or can be made executable
                if [ ! -x "$module/run.sh" ]; then
                  echo "  Making run.sh executable"
                  chmod +x "$module/run.sh"
                fi
                
                # Syntax check
                bash -n "$module/run.sh" || {
                  echo "✗ Syntax error in $module_name/run.sh"
                  exit 1
                }
              fi
              
              module_count=$((module_count + 1))
            fi
          done
          
          echo "✓ Found and validated $module_count modules"

  test-supported-env:
    name: Test Environment Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test environment configuration
        run: |
          echo "Testing supported environment configuration..."
          
          if [ ! -f ".supported_env.conf" ]; then
            echo "✗ .supported_env.conf not found"
            exit 1
          fi
          
          source .supported_env.conf
          
          # Verify required variables
          if [ -z "$SUPPORTED_ARCHITECTURES" ]; then
            echo "✗ SUPPORTED_ARCHITECTURES not defined"
            exit 1
          fi
          
          if [ -z "$SUPPORTED_SERVICE_MANAGER" ]; then
            echo "✗ SUPPORTED_SERVICE_MANAGER not defined"
            exit 1
          fi
          
          echo "Supported architectures: $SUPPORTED_ARCHITECTURES"
          echo "Supported service manager: $SUPPORTED_SERVICE_MANAGER"
          echo "✓ Environment configuration is valid"

      - name: Test system detection
        run: |
          source tsc_tools/func
          
          echo "Testing system detection..."
          system_info=$(detect_system_info)
          
          if [ -z "$system_info" ]; then
            echo "✗ System detection failed"
            exit 1
          fi
          
          echo "System information:"
          echo "$system_info" | jq '.'
          
          echo "✓ System detection works"

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common issues
        run: |
          echo "Checking for common shell script issues..."
          
          issues_found=0
          
          # Check for unquoted variables in critical places
          echo "Checking for potentially unquoted variables..."
          if grep -r -n 'rm.*\$[A-Za-z_]' --include="*.sh" tsc_tools/ | grep -v '"\$'; then
            echo "⚠️  Found potentially unquoted variables in rm commands"
            issues_found=1
          fi
          
          # Check for missing error handling
          echo "Checking for commands without error handling..."
          if grep -r -n '^[[:space:]]*cd ' --include="*.sh" tsc_tools/ | grep -v '||' | grep -v '&&'; then
            echo "⚠️  Found cd commands without error handling"
            issues_found=1
          fi
          
          # Check for TODO/FIXME comments
          echo "Checking for TODO/FIXME comments..."
          todo_count=$(grep -r -c 'TODO\|FIXME' --include="*.sh" tsc_tools/ | awk -F: '{sum+=$2} END {print sum}')
          if [ "$todo_count" -gt 0 ]; then
            echo "ℹ️  Found $todo_count TODO/FIXME comments"
            grep -r -n 'TODO\|FIXME' --include="*.sh" tsc_tools/ || true
          fi
          
          if [ $issues_found -eq 0 ]; then
            echo "✓ No critical issues found"
          else
            echo "⚠️  Some issues found - please review"
          fi
