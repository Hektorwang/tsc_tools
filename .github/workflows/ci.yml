name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './tsc_tools'
          severity: warning
          ignore_paths: './lib'

  test-build:
    name: Test Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix gzip tar

      - name: Make build script executable
        run: chmod +x build.sh

      - name: Run build
        run: ./build.sh

      - name: Verify build output
        run: |
          if [ ! -d "release" ]; then
            echo "Release directory not found"
            exit 1
          fi
          
          release_file=$(find release -name "tsc_tools-*.sh" | head -n 1)
          if [ -z "$release_file" ]; then
            echo "No release file found"
            exit 1
          fi
          
          echo "Build successful: $release_file"
          ls -lh "$release_file"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: tsc-tools-${{ matrix.os }}
          path: release/tsc_tools-*.sh
          retention-days: 7

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check bash syntax
        run: |
          find . -name "*.sh" -type f | while read -r script; do
            echo "Checking: $script"
            bash -n "$script" || exit 1
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential secrets..."
          
          # Check for common secret patterns
          if grep -r -i -E "(password|passwd|secret|api_key|token).*=.*['\"][^'\"]{8,}" \
             --include="*.sh" \
             --exclude-dir=".git" \
             --exclude-dir="lib" \
             . ; then
            echo "⚠️  Warning: Potential hardcoded secrets found"
            echo "Please review the above matches"
          else
            echo "✓ No obvious hardcoded secrets detected"
          fi

      - name: Check for unsafe commands
        run: |
          echo "Checking for potentially unsafe commands..."
          
          unsafe_patterns=(
            "rm -rf /"
            "chmod 777"
            "eval.*\$\("
          )
          
          found_issues=0
          for pattern in "${unsafe_patterns[@]}"; do
            if grep -r -E "$pattern" --include="*.sh" --exclude-dir=".git" --exclude-dir="lib" . ; then
              echo "⚠️  Found potentially unsafe pattern: $pattern"
              found_issues=1
            fi
          done
          
          if [ $found_issues -eq 0 ]; then
            echo "✓ No obvious unsafe patterns detected"
          fi
